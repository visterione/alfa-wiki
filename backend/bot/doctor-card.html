<!-- 
  Ğ¨ĞĞ‘Ğ›ĞĞ ĞšĞĞ Ğ¢ĞĞ§Ğ•Ğš Ğ’Ğ ĞĞ§Ğ•Ğ™ Ğ¡ Ğ˜ĞĞ¢Ğ•Ğ“Ğ ĞĞ¦Ğ˜Ğ•Ğ™ ĞœĞ˜Ğ¡ RENOVATIO v3
  Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾:
  1. Ğ¨ĞºĞ°Ğ»Ğ° Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ñ Ğ·ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¼Ğ¸ (ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾) Ğ¸ ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¼Ğ¸ (Ğ·Ğ°Ğ½ÑÑ‚Ğ¾) ÑĞ»Ğ¾Ñ‚Ğ°Ğ¼Ğ¸
  2. Ğ£ÑĞ»ÑƒĞ³Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ€Ğ°Ñ‡Ğ°
  3. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºĞ°Ğ¼
  4. Ğ¨ĞºĞ°Ğ»Ğ° 8:00-21:00
-->

<style>
.dc-app {
  --dc-primary: #2563eb;
  --dc-primary-hover: #1d4ed8;
  --dc-success: #10b981;
  --dc-warning: #f59e0b;
  --dc-danger: #ef4444;
  --dc-bg: #f8fafc;
  --dc-card-bg: #ffffff;
  --dc-border: #e2e8f0;
  --dc-text: #1e293b;
  --dc-text-secondary: #64748b;
  --dc-radius: 12px;
  --dc-shadow: 0 1px 3px rgba(0,0,0,0.1);
  --dc-shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
  --dc-inactive: #d1d5db;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--dc-bg);
  padding: 20px;
  min-height: 400px;
}

/* === HEADER === */
.dc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px; }
.dc-title { font-size: 22px; font-weight: 700; color: var(--dc-text); margin: 0; display: flex; align-items: center; gap: 10px; }
.dc-title svg { width: 26px; height: 26px; color: var(--dc-primary); }
.dc-stats { display: flex; gap: 12px; }
.dc-stat { background: var(--dc-card-bg); padding: 8px 14px; border-radius: 8px; border: 1px solid var(--dc-border); font-size: 13px; color: var(--dc-text-secondary); }
.dc-stat strong { color: var(--dc-primary); font-size: 16px; margin-right: 4px; }

/* === TOOLBAR === */
.dc-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
.dc-filters { display: flex; gap: 10px; flex-wrap: wrap; flex: 1; }
.dc-input, .dc-select { padding: 9px 12px; border: 1px solid var(--dc-border); border-radius: 8px; font-size: 13px; background: var(--dc-card-bg); color: var(--dc-text); }
.dc-input:focus, .dc-select:focus { outline: none; border-color: var(--dc-primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
.dc-search-input { min-width: 200px; }

/* === BUTTONS === */
.dc-btn { display: inline-flex; align-items: center; gap: 6px; padding: 9px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.dc-btn svg { width: 16px; height: 16px; }
.dc-btn-primary { background: var(--dc-primary); color: white; }
.dc-btn-primary:hover { background: var(--dc-primary-hover); }
.dc-btn-secondary { background: var(--dc-card-bg); color: var(--dc-text); border: 1px solid var(--dc-border); }
.dc-btn-secondary:hover { background: var(--dc-bg); }
.dc-btn-icon { padding: 7px; min-width: 32px; justify-content: center; }

/* === CARDS === */
.dc-cards { display: flex; flex-direction: column; gap: 16px; }

/* === CARD === */
.dc-card { background: var(--dc-card-bg); border-radius: var(--dc-radius); border: 1px solid var(--dc-border); overflow: hidden; transition: all 0.3s; }
.dc-card:hover { box-shadow: var(--dc-shadow-lg); }
.dc-card.highlighted { border-color: var(--dc-primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.2); }

/* Clinic badges */
.dc-clinics { display: flex; gap: 6px; padding: 12px 16px; background: var(--dc-bg); border-bottom: 1px solid var(--dc-border); flex-wrap: wrap; }
.dc-clinic { 
  min-width: 70px; padding: 5px 10px; border-radius: 6px; 
  display: flex; align-items: center; justify-content: center; 
  font-size: 11px; font-weight: 600; color: white; 
  background: var(--dc-inactive); transition: all 0.2s; text-align: center;
}
.dc-clinic.active { opacity: 1; }

/* Card header */
.dc-card-header { display: flex; justify-content: space-between; align-items: flex-start; padding: 16px; gap: 12px; }
.dc-card-info { flex: 1; min-width: 0; }
.dc-card-name { font-size: 17px; font-weight: 600; color: var(--dc-text); margin: 0 0 4px 0; }
.dc-card-name a { color: inherit; text-decoration: none; }
.dc-card-name a:hover { color: var(--dc-primary); }
.dc-card-specialty { font-size: 13px; color: var(--dc-primary); font-weight: 500; margin-bottom: 8px; }
.dc-card-details { display: flex; flex-wrap: wrap; gap: 12px; font-size: 12px; color: var(--dc-text-secondary); }

/* Tabs */
.dc-tabs { display: flex; gap: 4px; }
.dc-tab { padding: 6px 10px; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.2s; }
.dc-tab:hover { background: var(--dc-bg); }
.dc-tab.active { background: var(--dc-primary); color: white; }
.dc-tab.btn-edit:hover { background: #dbeafe; }
.dc-tab.btn-delete:hover { background: #fee2e2; }

/* Card body */
.dc-card-body { padding: 16px; border-top: 1px solid var(--dc-border); }
.dc-tab-content { display: none; }
.dc-tab-content.active { display: block; }

/* Notes */
.dc-notes { font-size: 13px; color: var(--dc-text-secondary); line-height: 1.6; margin-bottom: 16px; }

/* Timeline - ĞĞĞ’Ğ«Ğ• Ğ¡Ğ¢Ğ˜Ğ›Ğ˜ */
.dc-timeline-container { margin-top: 12px; }
.dc-timeline-legend { display: flex; gap: 16px; margin-bottom: 8px; font-size: 11px; color: var(--dc-text-secondary); }
.dc-timeline-legend span { display: flex; align-items: center; gap: 4px; }
.dc-timeline-legend .dot { width: 12px; height: 12px; border-radius: 3px; }
.dc-timeline-legend .dot.free { background: var(--dc-success); }
.dc-timeline-legend .dot.busy { background: var(--dc-danger); }
.dc-timeline-legend .dot.past { background: #cbd5e1; }
.dc-timeline-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--dc-text-secondary); margin-bottom: 4px; padding: 0 2px; }
.dc-timeline { display: flex; height: 28px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
.dc-timeline-slot { flex: 1; border-right: 1px solid rgba(255,255,255,0.5); transition: background 0.2s; position: relative; }
.dc-timeline-slot:last-child { border-right: none; }
.dc-timeline-slot.working { background: var(--dc-success); } /* Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾ - Ğ·ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹ */
.dc-timeline-slot.busy { background: var(--dc-danger); } /* Ğ—Ğ°Ğ½ÑÑ‚Ğ¾ - ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¹ */
.dc-timeline-slot.past { background: #cbd5e1; } /* ĞŸÑ€Ğ¾ÑˆĞµĞ´ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ */
.dc-timeline-slot:hover::after { 
  content: attr(data-time); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
  background: #1e293b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; white-space: nowrap; z-index: 10;
}

/* Services table */
.dc-services-container { max-height: 300px; overflow-y: auto; }
.dc-services-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.dc-services-table th { background: var(--dc-bg); padding: 8px 10px; text-align: left; font-weight: 600; color: var(--dc-text); border-bottom: 1px solid var(--dc-border); position: sticky; top: 0; }
.dc-services-table td { padding: 8px 10px; border-bottom: 1px solid var(--dc-border); color: var(--dc-text-secondary); }
.dc-services-table tr:hover td { background: #f8fafc; }

/* === MODAL === */
.dc-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.3s; }
.dc-modal.active { opacity: 1; visibility: visible; }
.dc-modal-content { background: var(--dc-card-bg); border-radius: var(--dc-radius); width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; transform: scale(0.9); transition: transform 0.3s; }
.dc-modal.active .dc-modal-content { transform: scale(1); }
.dc-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--dc-border); }
.dc-modal-header h3 { margin: 0; font-size: 18px; font-weight: 600; color: var(--dc-text); }
.dc-modal-close { width: 32px; height: 32px; border: none; background: var(--dc-bg); border-radius: 8px; font-size: 20px; cursor: pointer; color: var(--dc-text-secondary); display: flex; align-items: center; justify-content: center; }
.dc-modal-close:hover { background: var(--dc-border); }
.dc-modal-body { padding: 20px; overflow-y: auto; flex: 1; }
.dc-modal-footer { padding: 16px 20px; border-top: 1px solid var(--dc-border); display: flex; justify-content: flex-end; gap: 10px; }

/* Form */
.dc-form-group { margin-bottom: 16px; }
.dc-form-group label { display: block; font-size: 13px; font-weight: 500; color: var(--dc-text); margin-bottom: 6px; }
.dc-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.dc-textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--dc-border); border-radius: 8px; font-size: 13px; resize: vertical; min-height: 80px; font-family: inherit; }
.dc-textarea:focus { outline: none; border-color: var(--dc-primary); }

/* Clinics checkboxes */
.dc-clinics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.dc-clinic-check { padding: 10px; border: 2px solid var(--dc-border); border-radius: 8px; cursor: pointer; text-align: center; font-size: 12px; font-weight: 500; transition: all 0.2s; }
.dc-clinic-check:hover { border-color: var(--dc-primary); }
.dc-clinic-check.selected { border-color: var(--dc-primary); background: rgba(37,99,235,0.1); }
.dc-clinic-check input { display: none; }

/* Search dropdown */
.dc-search-wrapper { position: relative; }
.dc-search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--dc-card-bg); border: 1px solid var(--dc-border); border-radius: 8px; margin-top: 4px; max-height: 250px; overflow-y: auto; z-index: 100; box-shadow: var(--dc-shadow-lg); display: none; }
.dc-search-results.active { display: block; }
.dc-search-result { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid var(--dc-border); }
.dc-search-result:last-child { border-bottom: none; }
.dc-search-result:hover { background: var(--dc-bg); }
.dc-search-result-name { font-weight: 500; color: var(--dc-text); font-size: 14px; }
.dc-search-result-spec { font-size: 12px; color: var(--dc-text-secondary); margin-top: 2px; }

/* Loading & Empty */
.dc-loading, .dc-empty { text-align: center; padding: 60px 20px; color: var(--dc-text-secondary); }
.dc-empty svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
.dc-empty h3 { margin: 0 0 8px 0; color: var(--dc-text); }

/* Toast */
.dc-toast { position: fixed; bottom: 20px; right: 20px; padding: 14px 20px; border-radius: 8px; background: #1e293b; color: white; font-size: 14px; z-index: 10001; opacity: 0; transform: translateY(20px); transition: all 0.3s; }
.dc-toast.show { opacity: 1; transform: translateY(0); }
.dc-toast.success { background: var(--dc-success); }
.dc-toast.error { background: var(--dc-danger); }

/* Responsive */
@media (max-width: 768px) {
  .dc-app { padding: 16px; }
  .dc-header { flex-direction: column; align-items: flex-start; }
  .dc-toolbar { flex-direction: column; }
  .dc-filters { width: 100%; flex-direction: column; }
  .dc-search-input { width: 100%; min-width: unset; }
  .dc-form-row { grid-template-columns: 1fr; }
  .dc-clinics-grid { grid-template-columns: repeat(2, 1fr); }
  .dc-card-header { flex-direction: column; }
  .dc-tabs { margin-top: 12px; }
}
</style>

<div class="dc-app" id="doctors-app">
  <div class="dc-header">
    <h2 class="dc-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ€Ğ°Ñ‡ĞµĞ¹
    </h2>
    <div class="dc-stats">
      <div class="dc-stat">Ğ’ÑĞµĞ³Ğ¾: <strong id="stat-total">0</strong></div>
    </div>
  </div>

  <div class="dc-toolbar">
    <div class="dc-filters">
      <input type="text" class="dc-input dc-search-input" id="filter-search" placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¤Ğ˜Ğ..." oninput="dcApp.debounceFilter()">
      <select class="dc-select" id="filter-specialty" onchange="dcApp.filterCards()">
        <option value="">Ğ’ÑĞµ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸</option>
      </select>
      <select class="dc-select" id="filter-clinic" onchange="dcApp.filterCards()">
        <option value="">Ğ’ÑĞµ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸</option>
        <option value="1">ĞĞ»ÑŒÑ„Ğ°</option>
        <option value="2">ĞšĞ¸Ğ´Ñ</option>
        <option value="3">ĞŸÑ€Ğ¾Ñ„</option>
        <option value="4">Ğ›Ğ¸Ğ½Ğ¸Ñ</option>
        <option value="5">3Ğš</option>
        <option value="6">Ğ¡Ğ¼Ğ°Ğ¹Ğ»</option>
      </select>
    </div>
    <button class="dc-btn dc-btn-primary" onclick="dcApp.openAddModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ€Ğ°Ñ‡Ğ°
    </button>
  </div>

  <div id="dc-cards-container" class="dc-cards">
    <div class="dc-loading">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
  </div>

  <!-- Modal -->
  <div id="dc-modal" class="dc-modal">
    <div class="dc-modal-content">
      <div class="dc-modal-header">
        <h3 id="modal-title">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ€Ğ°Ñ‡Ğ°</h3>
        <button type="button" class="dc-modal-close" onclick="dcApp.closeModal()">&times;</button>
      </div>
      <form id="dc-form" onsubmit="dcApp.saveCard(event)">
        <div class="dc-modal-body">
          <input type="hidden" id="edit-id">
          <input type="hidden" id="edit-mis-user-id">
          
          <div class="dc-form-group">
            <label>ĞŸĞ¾Ğ¸ÑĞº Ğ²Ñ€Ğ°Ñ‡Ğ° Ğ² ĞœĞ˜Ğ¡</label>
            <div class="dc-search-wrapper">
              <input type="text" id="mis-search" class="dc-input" placeholder="ĞĞ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¤Ğ˜Ğ..." oninput="dcApp.searchMIS(this.value)">
              <div id="mis-search-results" class="dc-search-results"></div>
            </div>
          </div>
          
          <div class="dc-form-group">
            <label>Ğ¤Ğ˜Ğ *</label>
            <input type="text" id="edit-fullname" required class="dc-input" placeholder="Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜Ğ²Ğ°Ğ½ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‡">
          </div>
          
          <div class="dc-form-row">
            <div class="dc-form-group">
              <label>Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ</label>
              <input type="text" id="edit-specialty" class="dc-input" placeholder="Ğ¡Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¾Ğ»Ğ¾Ğ³-Ñ‚ĞµÑ€Ğ°Ğ¿ĞµĞ²Ñ‚">
            </div>
            <div class="dc-form-group">
              <label>Ğ¡Ñ‚Ğ°Ğ¶</label>
              <input type="text" id="edit-experience" class="dc-input" placeholder="15 Ğ»ĞµÑ‚">
            </div>
          </div>
          
          <div class="dc-form-row">
            <div class="dc-form-group">
              <label>Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²</label>
              <input type="text" id="edit-age-range" class="dc-input" placeholder="0+">
            </div>
            <div class="dc-form-group">
              <label>Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ</label>
              <input type="text" id="edit-profile-url" class="dc-input" placeholder="/page/ivanov">
            </div>
          </div>

          <div class="dc-form-row">
            <div class="dc-form-group">
              <label>Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€</label>
              <input type="text" id="edit-internal" class="dc-input" placeholder="123">
            </div>
            <div class="dc-form-group">
              <label>ĞœĞ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹</label>
              <input type="text" id="edit-mobile" class="dc-input" placeholder="+7 (999) 123-45-67">
            </div>
          </div>
          
          <div class="dc-form-group">
            <label>ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸</label>
            <div id="clinics-checkboxes" class="dc-clinics-grid"></div>
          </div>
          
          <div class="dc-form-group">
            <label>Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸</label>
            <textarea id="edit-notes" class="dc-textarea" rows="3" placeholder="Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²Ñ€Ğ°Ñ‡Ğµ..."></textarea>
          </div>
        </div>
        
        <div class="dc-modal-footer">
          <button type="button" class="dc-btn dc-btn-secondary" onclick="dcApp.closeModal()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
          <button type="submit" class="dc-btn dc-btn-primary">ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
        </div>
      </form>
    </div>
  </div>

  <div id="dc-toast" class="dc-toast"></div>
</div>

<script>
window.dcApp = (function() {
  var API_BASE = window.location.protocol + '//' + window.location.hostname + ':9001/api';
  var PAGE_SLUG = getPageSlug();
  var cards = [];
  var filteredCards = [];
  var debounceTimer = null;
  var searchTimer = null;
  var highlightId = null;
  var isInitialized = false;
  var eventListenersAdded = false;

  // ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸
  var CLINICS = [
    { id: 1, name: 'ĞĞ»ÑŒÑ„Ğ°', color: '#FF80AB' },
    { id: 2, name: 'ĞšĞ¸Ğ´Ñ', color: '#FFA726' },
    { id: 3, name: 'ĞŸÑ€Ğ¾Ñ„', color: '#7E57C2' },
    { id: 4, name: 'Ğ›Ğ¸Ğ½Ğ¸Ñ', color: '#C5E1A5' },
    { id: 5, name: '3Ğš', color: '#BA68C8' },
    { id: 6, name: 'Ğ¡Ğ¼Ğ°Ğ¹Ğ»', color: '#555555' }
  ];
  
  // Timeline: 8:00-21:00 = 13 Ñ‡Ğ°ÑĞ¾Ğ² = 26 ÑĞ»Ğ¾Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ 30 Ğ¼Ğ¸Ğ½
  var TIMELINE_START = 8;
  var TIMELINE_END = 21;
  var TIMELINE_SLOTS = (TIMELINE_END - TIMELINE_START) * 2;

  function getPageSlug() {
    var path = window.location.pathname;
    var match = path.match(/\/page\/([^\/\?]+)/);
    return match ? match[1] : 'default';
  }

  function getToken() { return localStorage.getItem('token'); }

  function fetchAPI(url, options) {
    options = options || {};
    return fetch(url, {
      method: options.method || 'GET',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() },
      body: options.body
    }).then(function(r) {
      if (!r.ok) return r.json().then(function(e) { throw new Error(e.error || 'Error'); });
      return r.json();
    });
  }

  function showToast(msg, type) {
    var t = document.getElementById('dc-toast');
    if (!t) return;
    t.textContent = msg;
    t.className = 'dc-toast show ' + (type || '');
    setTimeout(function() { t.className = 'dc-toast'; }, 3000);
  }

  function escapeHtml(s) {
    if (!s) return '';
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DATA LOADING
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function loadCards() {
    fetchAPI(API_BASE + '/doctor-cards/page/' + PAGE_SLUG + '?sortBy=sortOrder&sortOrder=ASC')
      .then(function(data) {
        cards = data;
        filteredCards = cards.slice();
        renderCards();
        loadSpecialties();
        var statEl = document.getElementById('stat-total');
        if (statEl) statEl.textContent = cards.length;
      })
      .catch(function(e) { showToast('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: ' + e.message, 'error'); });
  }

  function loadSpecialties() {
    fetchAPI(API_BASE + '/doctor-cards/page/' + PAGE_SLUG + '/specialties')
      .then(function(list) {
        var sel = document.getElementById('filter-specialty');
        if (!sel) return;
        sel.innerHTML = '<option value="">Ğ’ÑĞµ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸</option>' + list.map(function(s) {
          return '<option value="' + escapeHtml(s) + '">' + escapeHtml(s) + '</option>';
        }).join('');
      }).catch(function() {});
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDERING
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function renderCards() {
    var container = document.getElementById('dc-cards-container');
    if (!container) return;
    
    if (!filteredCards.length) {
      container.innerHTML = '<div class="dc-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg><h3>Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ²Ñ€Ğ°Ñ‡ĞµĞ¹ Ğ¿ÑƒÑÑ‚</h3><p>ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ€Ğ°Ñ‡Ğ°"</p></div>';
      return;
    }

    container.innerHTML = filteredCards.map(function(card) {
      var meta = card.metadata || {};
      var cardClinics = meta.clinics || [];
      var isHighlighted = highlightId && card.id === highlightId;

      var clinicBadges = CLINICS.map(function(c) {
        var isActive = cardClinics.indexOf(c.id) !== -1;
        var style = isActive ? 'background:' + c.color : '';
        return '<div class="dc-clinic' + (isActive ? ' active' : '') + '" style="' + style + '">' + c.name + '</div>';
      }).join('');

      var nameHtml = card.profileUrl 
        ? '<a href="' + escapeHtml(card.profileUrl) + '">' + escapeHtml(card.fullName) + '</a>'
        : escapeHtml(card.fullName);

      return '<div class="dc-card' + (isHighlighted ? ' highlighted' : '') + '" data-id="' + card.id + '">' +
        '<div class="dc-clinics">' + clinicBadges + '</div>' +
        '<div class="dc-card-header">' +
          '<div class="dc-card-info">' +
            '<h3 class="dc-card-name">' + nameHtml + '</h3>' +
            (card.specialty ? '<div class="dc-card-specialty">' + escapeHtml(card.specialty) + '</div>' : '') +
            '<div class="dc-card-details">' +
              (meta.ageRange ? '<div>ğŸ‘¶ ' + escapeHtml(meta.ageRange) + '</div>' : '') +
              (card.experience ? '<div>ğŸ“… ' + escapeHtml(card.experience) + '</div>' : '') +
              (meta.internalNumber ? '<div>ğŸ“ Ğ²Ğ½. ' + escapeHtml(meta.internalNumber) + '</div>' : '') +
              (meta.mobileNumber ? '<div>ğŸ“± ' + escapeHtml(meta.mobileNumber) + '</div>' : '') +
            '</div>' +
          '</div>' +
          '<div class="dc-tabs">' +
            '<button type="button" class="dc-tab active" data-card="' + card.id + '" data-tab="info" onclick="dcApp.switchTab(this)" title="Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ">ğŸ“‹</button>' +
            '<button type="button" class="dc-tab" data-card="' + card.id + '" data-tab="services" onclick="dcApp.switchTab(this)" title="Ğ£ÑĞ»ÑƒĞ³Ğ¸">ğŸ“Š</button>' +
            '<button type="button" class="dc-tab btn-edit" onclick="dcApp.openEditModal(\'' + card.id + '\')" title="Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ">âœï¸</button>' +
            '<button type="button" class="dc-tab btn-delete" onclick="dcApp.deleteCard(\'' + card.id + '\')" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ">ğŸ—‘ï¸</button>' +
          '</div>' +
        '</div>' +
        '<div class="dc-card-body" id="body-' + card.id + '">' +
          '<div class="dc-tab-content active" data-tab="info">' +
            (card.description ? '<div class="dc-notes">' + escapeHtml(card.description).replace(/\n/g, '<br>') + '</div>' : '<div class="dc-notes" style="color:#999">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚</div>') +
            '<div class="dc-timeline-container">' +
              '<div class="dc-timeline-legend"><span><div class="dot free"></div>Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾</span><span><div class="dot busy"></div>Ğ—Ğ°Ğ½ÑÑ‚Ğ¾</span><span><div class="dot past"></div>ĞŸÑ€Ğ¾ÑˆĞ»Ğ¾</span></div>' +
              '<div class="dc-timeline-labels" id="labels-' + card.id + '"></div>' +
              '<div class="dc-timeline" id="timeline-' + card.id + '"></div>' +
            '</div>' +
          '</div>' +
          '<div class="dc-tab-content" data-tab="services">' +
            '<div class="dc-services-container">' +
              '<table class="dc-services-table"><thead><tr><th>ĞšĞ¾Ğ´</th><th>Ğ£ÑĞ»ÑƒĞ³Ğ°</th><th>Ğ”Ğ»Ğ¸Ñ‚.</th><th>Ğ¦ĞµĞ½Ğ°</th></tr></thead>' +
              '<tbody id="services-' + card.id + '"><tr><td colspan="4" style="text-align:center;color:#999">ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ğŸ“Š Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸</td></tr></tbody></table>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }).join('');

    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº
    filteredCards.forEach(function(card) {
      if (card.metadata && card.metadata.misUserId) {
        loadSchedule(card.id, card.metadata.misUserId);
      } else {
        renderEmptyTimeline(card.id);
      }
    });

    if (highlightId) {
      setTimeout(function() {
        var el = document.querySelector('[data-id="' + highlightId + '"]');
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 100);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIMELINE & SCHEDULE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function slotToTime(slotIndex) {
    var totalMinutes = TIMELINE_START * 60 + slotIndex * 30;
    var h = Math.floor(totalMinutes / 60);
    var m = totalMinutes % 60;
    return h + ':' + (m < 10 ? '0' : '') + m;
  }

  function timeToSlot(timeStr) {
    if (!timeStr) return -1;
    var parts = timeStr.split(':');
    var h = parseInt(parts[0]);
    var m = parseInt(parts[1] || 0);
    var slot = (h - TIMELINE_START) * 2 + Math.floor(m / 30);
    return Math.max(0, Math.min(TIMELINE_SLOTS - 1, slot));
  }

  function renderEmptyTimeline(cardId) {
    var timeline = document.getElementById('timeline-' + cardId);
    var labels = document.getElementById('labels-' + cardId);
    if (!timeline || !labels) return;

    var hours = [];
    for (var h = TIMELINE_START; h <= TIMELINE_END; h++) hours.push(h + ':00');
    labels.innerHTML = hours.map(function(h) { return '<span>' + h + '</span>'; }).join('');

    var slots = '';
    for (var i = 0; i < TIMELINE_SLOTS; i++) {
      slots += '<div class="dc-timeline-slot" data-time="' + slotToTime(i) + '"></div>';
    }
    timeline.innerHTML = slots;
  }

  function loadSchedule(cardId, misUserId) {
    var timeline = document.getElementById('timeline-' + cardId);
    var labels = document.getElementById('labels-' + cardId);
    if (!timeline || !labels) return;

    // Labels
    var hours = [];
    for (var h = TIMELINE_START; h <= TIMELINE_END; h++) hours.push(h + ':00');
    labels.innerHTML = hours.map(function(h) { return '<span>' + h + '</span>'; }).join('');

    // Empty slots
    var slotsHtml = '';
    for (var i = 0; i < TIMELINE_SLOTS; i++) {
      slotsHtml += '<div class="dc-timeline-slot" data-time="' + slotToTime(i) + '"></div>';
    }
    timeline.innerHTML = slotsHtml;

    var today = getTodayDate();
    
    // ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
    Promise.all([
      fetchAPI(API_BASE + '/mis/schedule-periods', {
        method: 'POST',
        body: JSON.stringify({ user_id: misUserId })
      }).catch(function() { return { error: 1, data: [] }; }),
      
      fetchAPI(API_BASE + '/mis/schedule', {
        method: 'POST',
        body: JSON.stringify({ user_id: misUserId, date_start: today, date_end: today })
      }).catch(function() { return { error: 1, data: [] }; })
    ]).then(function(results) {
      var periodsData = results[0];
      var scheduleData = results[1];
      
      renderSchedule(cardId, periodsData, scheduleData);
    });
  }

  function getTodayDate() {
    var d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
  }

  function renderSchedule(cardId, periodsData, scheduleData) {
    var timeline = document.getElementById('timeline-' + cardId);
    if (!timeline) return;
    
    var slots = timeline.querySelectorAll('.dc-timeline-slot');
    var workingSlots = new Set();
    var busySlots = new Set();
    
    // 1. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğµ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹ (ĞºĞ¾Ğ³Ğ´Ğ° Ğ²Ñ€Ğ°Ñ‡ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚)
    // API getSchedulePeriods Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ²Ñ€Ğ°Ñ‡Ğ°
    if (periodsData.error === 0 && periodsData.data) {
      var periods = Array.isArray(periodsData.data) ? periodsData.data : [periodsData.data];
      var today = getTodayDate();
      
      periods.forEach(function(period) {
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
        if (period.date === today || !period.date) {
          var startSlot = timeToSlot(period.time_start || period.start_time || '08:00');
          var endSlot = timeToSlot(period.time_end || period.end_time || '21:00');
          
          for (var i = startSlot; i < endSlot && i < TIMELINE_SLOTS; i++) {
            if (i >= 0) workingSlots.add(i);
          }
        }
      });
    }
    
    // Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°Ñ…, ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ²Ñ€Ğ°Ñ‡ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ²ĞµÑÑŒ Ğ´ĞµĞ½ÑŒ
    if (workingSlots.size === 0) {
      for (var i = 0; i < TIMELINE_SLOTS; i++) {
        workingSlots.add(i);
      }
    }
    
    // 2. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ·Ğ°Ğ½ÑÑ‚Ñ‹Ğµ ÑĞ»Ğ¾Ñ‚Ñ‹ (Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²)
    // API getSchedule Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼
    if (scheduleData.error === 0 && scheduleData.data) {
      var appointments = Array.isArray(scheduleData.data) ? scheduleData.data : [scheduleData.data];
      
      appointments.forEach(function(appt) {
        // Ğ£ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ ĞµÑÑ‚ÑŒ time_start Ğ¸ time_end
        if (appt.time_start && appt.time_end) {
          var startSlot = timeToSlot(appt.time_start);
          var endSlot = timeToSlot(appt.time_end);
          
          for (var i = startSlot; i < endSlot && i < TIMELINE_SLOTS; i++) {
            if (i >= 0) busySlots.add(i);
          }
        }
      });
    }
    
    // 3. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¾ÑˆĞµĞ´ÑˆĞ¸Ğµ ÑĞ»Ğ¾Ñ‚Ñ‹
    var now = new Date();
    var currentSlot = (now.getHours() - TIMELINE_START) * 2 + Math.floor(now.getMinutes() / 30);
    
    // 4. ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ ĞºĞ»Ğ°ÑÑÑ‹ Ğº ÑĞ»Ğ¾Ñ‚Ğ°Ğ¼
    slots.forEach(function(slot, index) {
      slot.className = 'dc-timeline-slot';
      slot.setAttribute('data-time', slotToTime(index));
      
      if (index < currentSlot) {
        // ĞŸÑ€Ğ¾ÑˆĞµĞ´ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ
        slot.classList.add('past');
      } else if (busySlots.has(index)) {
        // Ğ—Ğ°Ğ½ÑÑ‚Ğ¾ (ĞµÑÑ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ) - ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¹
        slot.classList.add('busy');
      } else if (workingSlots.has(index)) {
        // Ğ Ğ°Ğ±Ğ¾Ñ‡ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¸ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾ - Ğ·ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹
        slot.classList.add('working');
      }
      // Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‡ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ - Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ ÑĞµÑ€Ñ‹Ğ¹ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ)
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SERVICES - Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑƒÑĞ»ÑƒĞ³ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ€Ğ°Ñ‡Ğ°
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function loadServices(cardId, misUserId) {
    var tbody = document.getElementById('services-' + cardId);
    if (!tbody) return;
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr>';

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ²Ñ€Ğ°Ñ‡Ğ° Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ ĞµĞ³Ğ¾ services (Ğ¼Ğ°ÑÑĞ¸Ğ² ID ÑƒÑĞ»ÑƒĞ³)
    fetchAPI(API_BASE + '/mis/doctor-info', {
      method: 'POST',
      body: JSON.stringify({ userId: misUserId })
    }).then(function(data) {
      console.log('ğŸ‘¨â€âš•ï¸ Doctor info:', data);
      
      if (!data.success || !data.data) {
        throw new Error('NO_DOCTOR');
      }
      
      var doctor = data.data;
      var serviceIds = doctor.services;
      
      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞµÑÑ‚ÑŒ Ğ¼Ğ°ÑÑĞ¸Ğ² ÑƒÑĞ»ÑƒĞ³
      if (!serviceIds || !Array.isArray(serviceIds) || serviceIds.length === 0) {
        throw new Error('NO_SERVICES');
      }
      
      console.log('ğŸ“‹ Doctor service IDs:', serviceIds);
      
      // Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ğ¸Ñ… ÑƒÑĞ»ÑƒĞ³
      return fetchAPI(API_BASE + '/mis/services', {
        method: 'POST',
        body: JSON.stringify({ service_ids: serviceIds })
      });
    }).then(function(servData) {
      console.log('ğŸ¥ Services response:', servData);
      
      if (servData.error !== 0) {
        throw new Error('API_ERROR');
      }
      
      var services = [];
      if (servData.data) {
        services = Array.isArray(servData.data) ? servData.data : [servData.data];
        services = services.filter(function(s) { return s && (s.title || s.code); });
      }
      
      if (services.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">Ğ£ÑĞ»ÑƒĞ³Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</td></tr>';
        return;
      }
      
      tbody.innerHTML = services.map(function(s) {
        return '<tr>' +
          '<td>' + (s.code || s.id || 'â€”') + '</td>' +
          '<td>' + escapeHtml(s.title || s.name || 'â€”') + '</td>' +
          '<td>' + (s.duration ? s.duration + ' Ğ¼Ğ¸Ğ½' : 'â€”') + '</td>' +
          '<td>' + (s.price ? Number(s.price).toLocaleString('ru-RU') + ' â‚½' : 'â€”') + '</td>' +
        '</tr>';
      }).join('');
      
    }).catch(function(e) {
      console.log('âŒ Services error:', e.message);
      
      var msg = 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸';
      if (e.message === 'NO_DOCTOR') msg = 'Ğ’Ñ€Ğ°Ñ‡ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² ĞœĞ˜Ğ¡';
      if (e.message === 'NO_SERVICES') msg = 'Ğ£ Ğ²Ñ€Ğ°Ñ‡Ğ° Ğ½ĞµÑ‚ ÑƒÑĞ»ÑƒĞ³';
      
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">' + msg + '</td></tr>';
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TABS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function switchTab(btn) {
    var cardId = btn.dataset.card;
    var tabName = btn.dataset.tab;
    var card = document.querySelector('[data-id="' + cardId + '"]');
    if (!card) return;

    card.querySelectorAll('.dc-tab[data-tab]').forEach(function(t) { t.classList.remove('active'); });
    btn.classList.add('active');

    var body = document.getElementById('body-' + cardId);
    if (!body) return;
    body.querySelectorAll('.dc-tab-content').forEach(function(c) { c.classList.remove('active'); });
    var content = body.querySelector('[data-tab="' + tabName + '"]');
    if (content) content.classList.add('active');

    if (tabName === 'services') {
      var cardData = cards.find(function(c) { return c.id === cardId; });
      if (cardData && cardData.metadata && cardData.metadata.misUserId) {
        loadServices(cardId, cardData.metadata.misUserId);
      } else {
        var tbody = document.getElementById('services-' + cardId);
        if (tbody) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">Ğ’Ñ€Ğ°Ñ‡ Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½ Ğº ĞœĞ˜Ğ¡</td></tr>';
      }
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FILTERING - Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ¼ Ğ¿Ğ¾ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºĞ°Ğ¼
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function filterCards() {
    var searchEl = document.getElementById('filter-search');
    var specEl = document.getElementById('filter-specialty');
    var clinicEl = document.getElementById('filter-clinic');
    
    var search = searchEl ? searchEl.value.toLowerCase() : '';
    var specialty = specEl ? specEl.value : '';
    var clinicId = clinicEl ? parseInt(clinicEl.value) : 0;

    filteredCards = cards.filter(function(c) {
      // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
      if (search && !c.fullName.toLowerCase().includes(search)) return false;
      
      // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
      if (specialty && c.specialty !== specialty) return false;
      
      // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºĞµ
      if (clinicId) {
        var cardClinics = (c.metadata && c.metadata.clinics) || [];
        if (cardClinics.indexOf(clinicId) === -1) return false;
      }
      
      return true;
    });

    renderCards();
  }

  function debounceFilter() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(filterCards, 300);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MIS SEARCH
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function searchMIS(query) {
    var resultsDiv = document.getElementById('mis-search-results');
    if (!resultsDiv) return;
    
    if (query.length < 2) {
      resultsDiv.classList.remove('active');
      return;
    }

    clearTimeout(searchTimer);
    searchTimer = setTimeout(function() {
      resultsDiv.innerHTML = '<div style="padding:12px;color:#999">ĞŸĞ¾Ğ¸ÑĞº...</div>';
      resultsDiv.classList.add('active');

      fetchAPI(API_BASE + '/mis/doctors', { method: 'POST', body: JSON.stringify({}) })
        .then(function(data) {
          var resultsDiv = document.getElementById('mis-search-results');
          if (!resultsDiv) return;
          
          if (data.error === 0 && data.data) {
            var doctors = Array.isArray(data.data) ? data.data : [];
            var filtered = doctors.filter(function(d) {
              var name = (d.name || (d.last_name + ' ' + d.first_name)).toLowerCase();
              return name.includes(query.toLowerCase());
            }).slice(0, 10);

            if (!filtered.length) {
              resultsDiv.innerHTML = '<div style="padding:12px;color:#999">ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</div>';
            } else {
              resultsDiv.innerHTML = filtered.map(function(d) {
                var name = d.name || (d.last_name + ' ' + d.first_name + ' ' + (d.middle_name || '')).trim();
                var specs = d.professions ? d.professions.map(function(p) { return p.title; }).join(', ') : '';
                var dataStr = encodeURIComponent(JSON.stringify(d));
                return '<div class="dc-search-result" onclick="dcApp.selectDoctor(decodeURIComponent(\'' + dataStr + '\'))">' +
                  '<div class="dc-search-result-name">' + escapeHtml(name) + '</div>' +
                  (specs ? '<div class="dc-search-result-spec">' + escapeHtml(specs) + '</div>' : '') +
                '</div>';
              }).join('');
            }
          }
        })
        .catch(function() {
          var resultsDiv = document.getElementById('mis-search-results');
          if (resultsDiv) resultsDiv.innerHTML = '<div style="padding:12px;color:#999">ĞÑˆĞ¸Ğ±ĞºĞ°</div>';
        });
    }, 400);
  }

  function selectDoctor(dataStr) {
    var doctor = JSON.parse(dataStr);
    var resultsDiv = document.getElementById('mis-search-results');
    if (resultsDiv) resultsDiv.classList.remove('active');
    
    var searchInput = document.getElementById('mis-search');
    if (searchInput) searchInput.value = '';

    var name = doctor.name || (doctor.last_name + ' ' + doctor.first_name + ' ' + (doctor.middle_name || '')).trim();
    var specs = doctor.professions ? doctor.professions.map(function(p) { return p.title; }).join(', ') : '';
    var clinicIds = doctor.clinics ? doctor.clinics.map(function(c) { return typeof c === 'object' ? c.id : c; }) : [];

    setValue('edit-fullname', name);
    setValue('edit-specialty', specs);
    setValue('edit-mis-user-id', doctor.id);
    setValue('edit-experience', doctor.work_period || '');
    setValue('edit-internal', doctor.internal_number || '');

    updateClinicCheckboxes(clinicIds);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MODAL & CRUD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function renderClinicsCheckboxes(selectedClinics) {
    var container = document.getElementById('clinics-checkboxes');
    if (!container) return;
    selectedClinics = selectedClinics || [];
    
    container.innerHTML = CLINICS.map(function(c) {
      var isSelected = selectedClinics.indexOf(c.id) !== -1;
      return '<div class="dc-clinic-check' + (isSelected ? ' selected' : '') + '" data-clinic-id="' + c.id + '" onclick="dcApp.toggleClinic(this)">' +
        '<input type="checkbox" value="' + c.id + '"' + (isSelected ? ' checked' : '') + '>' + c.name + '</div>';
    }).join('');
  }

  function toggleClinic(el) {
    var cb = el.querySelector('input[type="checkbox"]');
    cb.checked = !cb.checked;
    el.classList.toggle('selected', cb.checked);
  }

  function updateClinicCheckboxes(clinicIds) {
    var container = document.getElementById('clinics-checkboxes');
    if (!container) return;
    
    container.querySelectorAll('.dc-clinic-check').forEach(function(el) {
      var id = parseInt(el.dataset.clinicId);
      var isSelected = clinicIds.indexOf(id) !== -1;
      var cb = el.querySelector('input[type="checkbox"]');
      cb.checked = isSelected;
      el.classList.toggle('selected', isSelected);
    });
  }

  function getSelectedClinics() {
    var clinics = [];
    var container = document.getElementById('clinics-checkboxes');
    if (container) {
      container.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) {
        clinics.push(parseInt(cb.value));
      });
    }
    return clinics;
  }

  function openAddModal() {
    var form = document.getElementById('dc-form');
    if (form) form.reset();
    var titleEl = document.getElementById('modal-title');
    if (titleEl) titleEl.textContent = 'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ€Ğ°Ñ‡Ğ°';
    setValue('edit-id', '');
    setValue('edit-mis-user-id', '');
    renderClinicsCheckboxes([]);
    var modal = document.getElementById('dc-modal');
    if (modal) modal.classList.add('active');
  }

  function openEditModal(id) {
    var card = cards.find(function(c) { return c.id === id; });
    if (!card) return;
    var meta = card.metadata || {};
    
    var titleEl = document.getElementById('modal-title');
    if (titleEl) titleEl.textContent = 'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²Ñ€Ğ°Ñ‡Ğ°';
    
    setValue('edit-id', card.id);
    setValue('edit-mis-user-id', meta.misUserId || '');
    setValue('edit-fullname', card.fullName || '');
    setValue('edit-specialty', card.specialty || '');
    setValue('edit-experience', card.experience || '');
    setValue('edit-age-range', meta.ageRange || '');
    setValue('edit-profile-url', card.profileUrl || '');
    setValue('edit-internal', meta.internalNumber || '');
    setValue('edit-mobile', meta.mobileNumber || '');
    setValue('edit-notes', card.description || '');
    renderClinicsCheckboxes(meta.clinics || []);
    
    var modal = document.getElementById('dc-modal');
    if (modal) modal.classList.add('active');
  }

  function setValue(id, value) { var el = document.getElementById(id); if (el) el.value = value; }
  function getValue(id) { var el = document.getElementById(id); return el ? el.value.trim() : ''; }

  function closeModal() {
    var modal = document.getElementById('dc-modal');
    if (modal) modal.classList.remove('active');
  }

  function saveCard(e) {
    e.preventDefault();
    var id = getValue('edit-id');
    var data = {
      pageSlug: PAGE_SLUG,
      fullName: getValue('edit-fullname'),
      specialty: getValue('edit-specialty'),
      experience: getValue('edit-experience'),
      profileUrl: getValue('edit-profile-url'),
      description: getValue('edit-notes'),
      misUserId: getValue('edit-mis-user-id') || null,
      ageRange: getValue('edit-age-range'),
      internalNumber: getValue('edit-internal'),
      mobileNumber: getValue('edit-mobile'),
      clinics: getSelectedClinics()
    };

    var url = id ? API_BASE + '/doctor-cards/' + id : API_BASE + '/doctor-cards';
    fetchAPI(url, { method: id ? 'PUT' : 'POST', body: JSON.stringify(data) })
      .then(function() {
        showToast(id ? 'ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°' : 'Ğ’Ñ€Ğ°Ñ‡ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½', 'success');
        closeModal();
        loadCards();
      })
      .catch(function(e) { showToast('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + e.message, 'error'); });
  }

  function deleteCard(id) {
    if (!confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ²Ñ€Ğ°Ñ‡Ğ°?')) return;
    fetchAPI(API_BASE + '/doctor-cards/' + id, { method: 'DELETE' })
      .then(function() {
        showToast('ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°', 'success');
        loadCards();
      })
      .catch(function(e) { showToast('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + e.message, 'error'); });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function init() {
    if (isInitialized) return;
    isInitialized = true;
    
    if (!getToken()) {
      var app = document.getElementById('doctors-app');
      if (app) app.innerHTML = '<div style="padding:40px;text-align:center;color:#dc2626;">ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ</div>';
      return;
    }

    var urlParams = new URLSearchParams(window.location.search);
    highlightId = urlParams.get('highlight');
    loadCards();
    if (highlightId) window.history.replaceState({}, '', window.location.pathname);

    if (!eventListenersAdded) {
      eventListenersAdded = true;
      document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeModal(); });
      document.addEventListener('click', function(e) {
        var dcApp = document.getElementById('doctors-app');
        if (!dcApp) return;
        if (!e.target.closest('.dc-search-wrapper')) {
          var results = document.getElementById('mis-search-results');
          if (results && results.classList) results.classList.remove('active');
        }
      });
      var modal = document.getElementById('dc-modal');
      if (modal) modal.addEventListener('click', function(e) { if (e.target === modal) closeModal(); });
    }
  }

  init();

  return {
    loadCards: loadCards, debounceFilter: debounceFilter, filterCards: filterCards,
    openAddModal: openAddModal, openEditModal: openEditModal, closeModal: closeModal,
    saveCard: saveCard, deleteCard: deleteCard, switchTab: switchTab,
    searchMIS: searchMIS, selectDoctor: selectDoctor, toggleClinic: toggleClinic
  };
})();
</script>